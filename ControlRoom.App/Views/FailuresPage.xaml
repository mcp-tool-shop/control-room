<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="ControlRoom.App.Views.FailuresPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:ControlRoom.App.ViewModels"
    x:DataType="vm:FailuresViewModel"
    Title="Failures">

    <Grid RowDefinitions="Auto,*" Padding="16">
        <!-- Header -->
        <HorizontalStackLayout Spacing="12">
            <Label Text="Recurring Failures" FontSize="20" FontAttributes="Bold" VerticalOptions="Center" />
            <Button Text="Refresh" Command="{Binding RefreshCommand}" />
        </HorizontalStackLayout>

        <!-- Empty State -->
        <VerticalStackLayout
            Grid.Row="1"
            IsVisible="{Binding HasFailures, Converter={StaticResource InvertedBool}}"
            VerticalOptions="Center"
            HorizontalOptions="Center"
            Spacing="12">
            <Label Text="No failures recorded" FontSize="20" HorizontalOptions="Center" />
            <Label Text="When scripts fail, they'll be grouped here by error signature" Opacity="0.6" HorizontalOptions="Center" />
        </VerticalStackLayout>

        <!-- Failure Groups List -->
        <CollectionView
            Grid.Row="1"
            ItemsSource="{Binding FailureGroups}"
            IsVisible="{Binding HasFailures}">
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="vm:FailureGroupItem">
                    <Border Padding="12" Margin="0,6" StrokeShape="RoundRectangle 8" BackgroundColor="{AppThemeBinding Light=#FFF5F5, Dark=#2D1A1A}">
                        <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="Auto,*,Auto">
                            <!-- Count Badge -->
                            <Border
                                Padding="8,4"
                                Margin="0,0,12,0"
                                StrokeShape="RoundRectangle 4"
                                BackgroundColor="#8B0000"
                                VerticalOptions="Start">
                                <Label Text="{Binding CountBadge}" FontSize="14" FontAttributes="Bold" TextColor="#FFAAAA" />
                            </Border>

                            <!-- Error Preview -->
                            <VerticalStackLayout Grid.Column="1" Spacing="4">
                                <Label
                                    Text="{Binding PreviewText}"
                                    FontSize="13"
                                    FontFamily="Consolas"
                                    LineBreakMode="TailTruncation"
                                    TextColor="{AppThemeBinding Light=#CC0000, Dark=#FF6666}" />
                                <HorizontalStackLayout Spacing="8">
                                    <Label Text="{Binding LastSeenText}" FontSize="11" Opacity="0.6" />
                                    <Label Text="Â·" FontSize="11" Opacity="0.4" />
                                    <Label Text="{Binding ThingsText}" FontSize="11" Opacity="0.6" />
                                </HorizontalStackLayout>
                            </VerticalStackLayout>

                            <!-- Fingerprint (short) -->
                            <Label
                                Grid.Column="2"
                                Text="{Binding ShortFingerprint}"
                                FontSize="10"
                                FontFamily="Consolas"
                                Opacity="0.3"
                                VerticalOptions="Start" />

                            <!-- Action Buttons Row -->
                            <HorizontalStackLayout Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2" Spacing="8" Margin="0,8,0,0">
                                <Button
                                    Text="Latest"
                                    FontSize="11"
                                    Padding="8,4"
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:FailuresViewModel}}, Path=OpenLatestCommand}"
                                    CommandParameter="{Binding .}" />
                                <Button
                                    Text="First"
                                    FontSize="11"
                                    Padding="8,4"
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:FailuresViewModel}}, Path=OpenFirstCommand}"
                                    CommandParameter="{Binding .}"
                                    IsVisible="{Binding IsRecurring}" />
                                <Button
                                    Text="All Runs"
                                    FontSize="11"
                                    Padding="8,4"
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:FailuresViewModel}}, Path=ShowAllRunsCommand}"
                                    CommandParameter="{Binding .}"
                                    IsVisible="{Binding IsRecurring}" />
                                <Button
                                    Text="Retry"
                                    FontSize="11"
                                    Padding="8,4"
                                    BackgroundColor="#006400"
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:FailuresViewModel}}, Path=RetryLatestCommand}"
                                    CommandParameter="{Binding .}" />
                            </HorizontalStackLayout>
                        </Grid>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>
    </Grid>
</ContentPage>
