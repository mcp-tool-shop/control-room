<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="ControlRoom.App.Views.ThingsPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:ControlRoom.App.ViewModels"
    xmlns:queries="clr-namespace:ControlRoom.Infrastructure.Storage.Queries;assembly=ControlRoom.Infrastructure"
    x:DataType="vm:ThingsViewModel"
    Title="Things">

    <Grid RowDefinitions="Auto,*" Padding="16">
        <!-- Header -->
        <HorizontalStackLayout Spacing="12">
            <Button Text="Refresh" Command="{Binding RefreshCommand}" />
            <Button Text="+ New Thing" Command="{Binding NewThingCommand}" />
        </HorizontalStackLayout>

        <!-- Empty State -->
        <VerticalStackLayout
            Grid.Row="1"
            IsVisible="{Binding Things.Count, Converter={StaticResource IntToBoolInverter}}"
            VerticalOptions="Center"
            HorizontalOptions="Center"
            Spacing="12">
            <Label Text="No Things yet" FontSize="20" HorizontalOptions="Center" />
            <Label Text="A Thing is something you control: a script, a server, a task" Opacity="0.6" HorizontalOptions="Center" />
            <Button Text="+ Add Your First Thing" Command="{Binding NewThingCommand}" />
        </VerticalStackLayout>

        <!-- Things List -->
        <CollectionView Grid.Row="1" ItemsSource="{Binding Things}">
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="vm:ThingRunItem">
                    <Border Padding="12" Margin="0,4" StrokeShape="RoundRectangle 8">
                        <VerticalStackLayout Spacing="8">
                            <!-- Header Row -->
                            <Grid ColumnDefinitions="*,Auto,Auto">
                                <VerticalStackLayout Spacing="4">
                                    <Label Text="{Binding Item.Name}" FontSize="16" FontAttributes="Bold" />
                                    <Label Text="{Binding Item.Kind}" FontSize="12" Opacity="0.6" />
                                </VerticalStackLayout>

                                <!-- Expand Button -->
                                <Button
                                    Grid.Column="1"
                                    Text="â–¼ Args"
                                    FontSize="12"
                                    Padding="8,4"
                                    BackgroundColor="Transparent"
                                    TextColor="{AppThemeBinding Light=Gray, Dark=#888}"
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ThingsViewModel}}, Path=ToggleExpandCommand}"
                                    CommandParameter="{Binding .}" />

                                <!-- Quick Run Button -->
                                <Button
                                    Grid.Column="2"
                                    Text="â–¶ Run"
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ThingsViewModel}}, Path=RunThingCommand}"
                                    CommandParameter="{Binding .}"
                                    VerticalOptions="Center" />
                            </Grid>

                            <!-- Expanded Arguments Panel -->
                            <Border
                                IsVisible="{Binding IsExpanded}"
                                Padding="12"
                                BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#1E1E1E}"
                                StrokeShape="RoundRectangle 6">
                                <VerticalStackLayout Spacing="8">
                                    <!-- Arguments Input -->
                                    <VerticalStackLayout Spacing="4">
                                        <Label Text="Arguments" FontSize="12" FontAttributes="Bold" />
                                        <Entry
                                            Text="{Binding Arguments}"
                                            Placeholder="--verbose --config=prod"
                                            FontFamily="Consolas"
                                            FontSize="13" />
                                        <Label
                                            Text="{Binding CurrentArgDescription}"
                                            FontSize="11"
                                            Opacity="0.6"
                                            IsVisible="{Binding CurrentArgDescription, Converter={StaticResource StringToBool}}" />
                                    </VerticalStackLayout>

                                    <!-- AI Suggestions -->
                                    <VerticalStackLayout Spacing="4" IsVisible="{Binding Suggestions.Count, Converter={StaticResource IntToBool}}">
                                        <HorizontalStackLayout Spacing="8">
                                            <Label Text="ðŸ¤– Suggestions" FontSize="11" FontAttributes="Bold" Opacity="0.8" />
                                            <ActivityIndicator
                                                IsRunning="{Binding IsLoadingSuggestions}"
                                                IsVisible="{Binding IsLoadingSuggestions}"
                                                WidthRequest="14"
                                                HeightRequest="14" />
                                        </HorizontalStackLayout>
                                        <FlexLayout Wrap="Wrap" JustifyContent="Start">
                                            <BindableLayout.ItemsSource>
                                                <Binding Path="Suggestions" />
                                            </BindableLayout.ItemsSource>
                                            <BindableLayout.ItemTemplate>
                                                <DataTemplate x:DataType="vm:ArgSuggestionItem">
                                                    <Border
                                                        Padding="8,4"
                                                        Margin="0,0,6,6"
                                                        BackgroundColor="{Binding IsFromHistory, Converter={StaticResource HistoryToBgColor}}"
                                                        StrokeShape="RoundRectangle 4">
                                                        <Border.GestureRecognizers>
                                                            <TapGestureRecognizer
                                                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ThingRunItem}}, Path=UseSuggestionCommand}"
                                                                CommandParameter="{Binding .}" />
                                                        </Border.GestureRecognizers>
                                                        <VerticalStackLayout>
                                                            <Label Text="{Binding Value}" FontSize="12" FontFamily="Consolas" />
                                                            <Label Text="{Binding Description}" FontSize="10" Opacity="0.6" />
                                                        </VerticalStackLayout>
                                                    </Border>
                                                </DataTemplate>
                                            </BindableLayout.ItemTemplate>
                                        </FlexLayout>
                                    </VerticalStackLayout>

                                    <!-- Run with Args Button -->
                                    <Button
                                        Text="â–¶ Run with Args"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ThingsViewModel}}, Path=RunThingCommand}"
                                        CommandParameter="{Binding .}"
                                        HorizontalOptions="Start"
                                        Padding="12,6" />
                                </VerticalStackLayout>
                            </Border>
                        </VerticalStackLayout>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>
    </Grid>
</ContentPage>
